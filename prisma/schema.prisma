// ============================================
// Sch√©ma Prisma avec ENUM Role (incluant BUM)
// ============================================
// √Ä utiliser si vous gardez l'ENUM et ajoutez juste BUM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum pour les r√¥les (avec BUM ajout√©)
enum Role {
  ADMIN
  BUM          // üëà Ajout√©
  CONSULTANT
}

// Table Business Unit
model BusinessUnit {
  id          Int      @id @default(autoincrement())
  nom         String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]   @relation("BusinessUnitUsers")

  @@map("BusinessUnit")
}

// Table User
model User {
  id             Int            @id @default(autoincrement())
  username       String         @unique
  password       String
  role           Role           // üëà ENUM avec BUM
  businessUnitId Int?
  bumId          Int?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  businessUnit   BusinessUnit?  @relation("BusinessUnitUsers", fields: [businessUnitId], references: [id], onDelete: SetNull)
  bum            User?          @relation("BUMToConsultants", fields: [bumId], references: [id], onDelete: SetNull)
  consultants    User[]         @relation("BUMToConsultants")
  
  objectifs      Objectif[]     @relation("UserObjectifs")
  commentaires   Commentaire[]
  categories     Categorie[]

  @@index([businessUnitId])
  @@index([bumId])
  @@map("User")
}

model Categorie {
  id          Int        @id @default(autoincrement())
  nom         String     @unique
  description String?
  couleur     String?
  userId      Int        // ‚Üê CETTE LIGNE CAUSE LE PROBL√àME
  user        User       @relation(...)
  objectifs   Objectif[]
  createdAt   DateTime   @default(now())
}

model Objectif {
  id               Int           @id @default(autoincrement())
  description      String
  status           String        @default("En cours")
  validatedbyadmin Boolean       @default(false)
  annee            Int
  userid           Int
  categorieId      Int?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  user             User          @relation("UserObjectifs", fields: [userid], references: [id], onDelete: Cascade)
  categorie        Categorie?    @relation(fields: [categorieId], references: [id], onDelete: SetNull)
  commentaires     Commentaire[]

  @@index([userid])
  @@index([annee])
  @@index([categorieId])
  @@map("Objectif")
}

model Commentaire {
  id         Int      @id @default(autoincrement())
  contenu    String
  objectifId Int
  userid     Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  objectif   Objectif @relation(fields: [objectifId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userid], references: [id], onDelete: Cascade)

  @@index([objectifId])
  @@index([userid])
  @@map("Commentaire")
}
